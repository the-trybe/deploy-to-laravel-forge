# This file deploys a laravel application with zero downtime deployments and site isolation.
organization: "your-forge-organization"
server: "production-server"
github_repository: "username/repository"
github_branch: "main"

sites:
  - name: "example.com"
    domain_mode: "custom"
    project_type: "laravel"
    php_version: "php84"
    certificate: true
    install_composer_dependencies: true

    deployment_script: |
      $FORGE_COMPOSER install --no-dev --no-interaction --prefer-dist --optimize-autoloader

      ( flock -w 10 9 || exit 1
          echo 'Restarting FPM...'; sudo -S service $FORGE_PHP_FPM reload ) 9>/tmp/fpmlock

      $FORGE_PHP artisan migrate --force
      $FORGE_PHP artisan config:cache
      $FORGE_PHP artisan route:cache
      $FORGE_PHP artisan view:cache

    aliases:
      - "example2.com"

    processes:
      - name: "queue-worker"
        command: "php artisan queue:work --sleep=3 --tries=3 --max-time=3600"

    laravel_scheduler: true

    isolated: true
    isolated_user: "appuser"
    zero_downtime_deployments: true
    shared_paths:
      - "storage"

    environment: |
      APP_NAME="My Application"
      APP_ENV=production
      APP_KEY="${{ secrets.APP_KEY }}"
      APP_DEBUG=false
      APP_URL=https://example.com

      LOG_CHANNEL=stack
      LOG_LEVEL=error

      DB_CONNECTION=mysql
      DB_HOST=127.0.0.1
      DB_PORT=3306
      DB_DATABASE=my_database
      DB_USERNAME=forge
      DB_PASSWORD="${{ secrets.DB_PASSWORD }}"

      BROADCAST_DRIVER=redis
      CACHE_DRIVER=redis
      FILESYSTEM_DISK=local
      QUEUE_CONNECTION=redis
      SESSION_DRIVER=redis
      SESSION_LIFETIME=120

      REDIS_HOST=127.0.0.1
      REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}"
      REDIS_PORT=6379

      MAIL_MAILER=smtp
      MAIL_HOST=smtp.mailtrap.io
      MAIL_PORT=2525
      MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}"
      MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}"
      MAIL_ENCRYPTION=tls
      MAIL_FROM_ADDRESS=noreply@example.com
      MAIL_FROM_NAME="${APP_NAME}"

      AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
      AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
      AWS_DEFAULT_REGION=us-east-1
      AWS_BUCKET=my-bucket
